# 42. ⏰ 비동기 프로그래밍

## 📌 42.1 동기 처리와 비동기 처리

- 23장 “실행 컨텍스트”
    - 함수가 실행되려면 함수 실행 컨텍스트가 실행 컨텍스트 스택에 푸시되어야 한다.
    - 함수의 실행 순서는 실행 컨텍스트 스택으로 관리한다.

### 싱글 스레드 방식

> 자바스크립트 엔진은 싱글 스레드 방식으로 동작한다.

**자바스크립트 엔진은 단 하나의 실행 컨텍스트 스택을 갖는다.**

- 이는 함수를 실행할 수 있는 창구가 단 하나이며, 동시에 2개 이상의 함수를 동시에 실행할 수 없다는 것을 의미
- 실행 컨텍스트 스택의 최상위 요소인 ‘실행 중인 실행 컨텍스트’를 제외한 나머지 모든 실행 컨텍스트는 모두 실행 대기중인 태스크(tasks)들이다.
- 이처럼 한 번에 하나의 태스크만 실행할 수 있는 자바스크립트 엔진의 동작 방식을 `싱글 스레드 방식`이라고 한다.

<br>

## 📌 42.2 이벤트 루프와 태스크 큐

자바스크립트는 싱글 스레드로 동작한다는 특징이 있다는 것을 알았다. 하지만 브라우저가 동작하는 것을 보면 많은 탯스크가 동시에 처리되는 것처럼 느껴진다.

- 예를 들어, HTML 요소가 애니메이션 효과를 통해 움직이면서 이벤트를 처리하기도 하고, HTTP 요청을 통해 서버로부터 데이터를 가지고 오는 동시에 렌더링하기도 한다.

이처럼 자바스크립트의 동시성을 지원하는 것이 바로 `이벤트 루프(event loop)`이다.

브라우저는 `자바스크립트 엔진` 이외에도 `렌더링 엔진`과 `Web API` 제공

- Web API : ECMAScript 사양에 정의된 함수가 아니라 브라우저에서 제공하는 API
    - DOM API, 타이머 함수, HTTP 요청(Ajax)과 같은 비동기 처리 포함

![image](https://github.com/xoxojw/modern-js-deep-dive/assets/124491335/e5054d71-0f11-46e2-a90a-27c90d48093d)

<br>

### 자바스크립트 엔진 - 콜 스택, 힙

구글의 V8 자바스크립트 엔진을 비롯한 대부분의 자바스크립트 엔진은 크게 `콜 스택`, `힙` 2개의 영역으로 구분할 수 있다.

1. **콜 스택(call stack)**
    
    전역 코드나 함수 코드 등의 소스코드 평가 과정에서 생성된 실행 컨텍스트가 추가되고 제거되는 스택 자료구조인 실행 컨텍스트 스택이 바로 콜 스택이다.
    
2. **힙(heap)**
    
    객체가 저장되는 메모리 공간이다. 콜 스택의 요소인 실행 컨텍스트는 힙에 저장된 객체를 참조한다.
    
    > 사실 원시 값도 객체인 실행 컨텍스트에 저장되므로 자바스크립트의 모든 값은 객체로 힙에 저장된다고 할 수 있다.
    > 
    

자바스크립트 엔진은 태스크가 요청되면 콜 스택을 통해 요청된 작업을 순차적으로 실행할 뿐이다.

비동기 처리에서 소스코드의 평가와 실행을 제외한 모든 처리는 자바스크립트 엔진을 구동하는 환경인 브라우저 또는 Node.js가 담당한다.

- 예를 들어, 비동기 방식으로 동작하는 `setTimeout`의 콜백 함수의 평가와 실행은 자바스크립트 엔진이 담당하지만, 호출 스케줄링을 위한 타이머 설정과 콜백 함수의 등록은 브라우저 또는 Node.js가 담당
→ 이를 위해 브라우저 환경은 `태스크 큐`와 `이벤트 루프`를 제공함

<br>

### 브라우저 환경 - 태스크 큐, 이벤트 루프

브라우저 환경은 `태스크 큐`와 `이벤트 루프`를 제공한다.

1. **태스크 큐(task queue/event queue/callback queue)**
    
    setTimeout이나 setInterval과 같은 비동기 함수의 콜백 함수 또는 이벤트 핸들러가 일시적으로 보관되는 영역
    
    태스크 큐와 별도로 마이크로태스크 큐라는 것도 존재 (*45.7절 마이크로태스크 큐 참고*)
    
    > 마이크로태스크 큐 : 프로미스의 후속 처리 메서드의 콜백 함수를 일시적으로 보관
    > 
2. **이벤트 루프(event loop)**
    
    `콜 스택`에 현재 실행 중인 실행 컨텍스트가 있는지, 그리고 `태스크 큐`에 대기 중인 함수(콜백 함수, 이벤트 핸들러 등)가 있는지 반복해서 확인하는 역할
    
    만약 콜 스택이 비어있고, 태스크 큐에 대기 중인 함수가 있다면 이벤트 루프는 FIFO 방식으로 태스크 큐에 대기 중인 함수를 콜 스택으로 이동시킴 → 태스크 큐에 일시 보관된 함수들은 비동기 처리 방식으로 동작
    
<br>

**자바스크립트 엔진은 `싱글 스레드`로 동작하지만, 브라우저는 `멀티 스레드`로 동작한다.**

- 이 때, 싱글 스레드 방식으로 동작하는 것은 브라우저가 아니라 **브라우저에 내장된 자바스크립트 엔진**이라는 것을 기억할 것

모든 자바스크립트 코드가 자바스크립트 엔진에서 싱글 스레드 방식으로 동작한다면 자바스크립트는 비동기로 동작할 수 없다.

<br>